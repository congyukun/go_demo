# 系统架构文档

## 概述

Go Demo 是一个基于 Go 语言开发的 Web 应用项目，采用分层架构设计，提供用户管理和认证功能。项目遵循 Clean Architecture 原则，具有良好的可维护性和可扩展性。

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Client Layer                         │
│                    (Web/Mobile/API)                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     Presentation Layer                      │
│                      (HTTP Handlers)                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │  Auth Handler   │  │  User Handler   │  │   Router    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      Middleware Layer                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │
│  │    Auth     │ │   Logging   │ │   Tracing   │ │  CORS  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      Business Layer                         │
│                       (Services)                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │  Auth Service   │  │  User Service   │  │   Utils     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     Data Access Layer                       │
│                     (Repositories)                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ User Repository │  │   Database      │  │   Models    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │
│  │   MySQL     │ │   Logger    │ │  Validator  │ │ Config │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 分层说明

#### 1. Presentation Layer (表现层)
- **职责**: 处理 HTTP 请求和响应，参数验证，调用业务层
- **组件**:
  - `AuthHandler`: 处理认证相关请求
  - `UserHandler`: 处理用户管理请求
  - `Router`: 路由配置和管理

#### 2. Middleware Layer (中间件层)
- **职责**: 横切关注点，如认证、日志、追踪等
- **组件**:
  - `Auth`: JWT 认证中间件
  - `Logging`: 请求日志记录
  - `Tracing`: 链路追踪
  - `CORS`: 跨域资源共享

#### 3. Business Layer (业务层)
- **职责**: 核心业务逻辑处理，调用数据访问层
- **组件**:
  - `AuthService`: 认证业务逻辑
  - `UserService`: 用户管理业务逻辑
  - `Utils`: 工具类和辅助函数

#### 4. Data Access Layer (数据访问层)
- **职责**: 数据持久化和查询，封装数据库操作
- **组件**:
  - `UserRepository`: 用户数据访问
  - `Models`: 数据模型定义
  - `Database`: 数据库连接和配置

#### 5. Infrastructure Layer (基础设施层)
- **职责**: 提供基础服务和工具
- **组件**:
  - `MySQL`: 数据库服务
  - `Logger`: 日志服务
  - `Validator`: 数据验证
  - `Config`: 配置管理

## 核心组件

### 1. 认证系统

```go
// JWT 认证流程
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │───▶│   Login     │───▶│  Generate   │
│             │    │  Handler    │    │    JWT      │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Validate   │◀───│    Auth     │◀───│   Return    │
│ Credentials │    │  Service    │    │   Token     │
└─────────────┘    └─────────────┘    └─────────────┘
```

**特性**:
- JWT Token 生成和验证
- Access Token 和 Refresh Token 机制
- 密码 bcrypt 加密
- 用户会话管理

### 2. 用户管理系统

```go
// 用户管理流程
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │───▶│    User     │───▶│    User     │
│   Request   │    │   Handler   │    │   Service   │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Response   │◀───│  Validate   │◀───│    User     │
│             │    │   & Format  │    │ Repository  │
└─────────────┘    └─────────────┘    └─────────────┘
```

**功能**:
- 用户 CRUD 操作
- 用户状态管理
- 分页查询
- 数据验证和格式化

### 3. 配置管理

```yaml
# 配置层次结构
app:
  name: "go_demo"
  version: "1.0.0"
  
server:
  host: "0.0.0.0"
  port: 8080
  
database:
  driver: "mysql"
  dsn: "user:pass@tcp(localhost:3306)/db"
  
log:
  level: "info"
  format: "json"
```

**特性**:
- 多环境配置支持
- 配置热重载
- 环境变量覆盖
- 配置验证

## 数据模型

### 用户模型 (User)

```go
type User struct {
    ID           uint      `gorm:"primarykey"`
    Username     string    `gorm:"uniqueIndex;size:50"`
    Email        string    `gorm:"uniqueIndex;size:100"`
    PasswordHash string    `gorm:"size:255"`
    Phone        string    `gorm:"size:20"`
    Status       int       `gorm:"default:1"`
    Role         string    `gorm:"size:20;default:'user'"`
    LastLogin    *time.Time
    CreatedAt    time.Time
    UpdatedAt    time.Time
    DeletedAt    gorm.DeletedAt `gorm:"index"`
}
```

**字段说明**:
- `ID`: 主键，自增
- `Username`: 用户名，唯一索引
- `Email`: 邮箱，唯一索引
- `PasswordHash`: 密码哈希值
- `Phone`: 手机号
- `Status`: 用户状态 (0=禁用, 1=启用)
- `Role`: 用户角色
- `LastLogin`: 最后登录时间
- `CreatedAt/UpdatedAt`: 创建/更新时间
- `DeletedAt`: 软删除时间

## 安全设计

### 1. 认证安全

- **密码加密**: 使用 bcrypt 算法加密存储
- **JWT 安全**: 
  - 使用 HS256 算法签名
  - 设置合理的过期时间
  - 支持 Token 刷新机制
- **会话管理**: 
  - 无状态认证
  - 支持登出功能

### 2. 数据安全

- **输入验证**: 
  - 使用 validator 库进行参数验证
  - 防止 SQL 注入
  - XSS 防护
- **数据脱敏**: 
  - 响应中不包含敏感信息
  - 密码字段不返回给客户端

### 3. 接口安全

- **CORS 配置**: 跨域资源共享控制
- **请求限流**: 防止 API 滥用
- **错误处理**: 统一错误响应，不泄露系统信息

## 性能优化

### 1. 数据库优化

- **索引设计**: 
  - 用户名和邮箱唯一索引
  - 软删除索引
- **连接池**: 
  - 配置合理的连接池参数
  - 连接复用和超时控制
- **查询优化**: 
  - 分页查询
  - 避免 N+1 查询

### 2. 缓存策略

- **应用缓存**: 
  - 配置信息缓存
  - 用户会话缓存
- **数据库缓存**: 
  - 查询结果缓存
  - 热点数据缓存

### 3. 日志优化

- **结构化日志**: 使用 Zap 高性能日志库
- **日志轮转**: 自动日志文件轮转
- **异步写入**: 减少 I/O 阻塞

## 监控和运维

### 1. 健康检查

```go
// 健康检查端点
GET /health
{
  "status": "ok",
  "time": "2023-12-01T10:00:00Z"
}
```

### 2. 日志监控

- **请求日志**: 记录所有 API 请求
- **错误日志**: 记录系统错误和异常
- **性能日志**: 记录慢查询和性能指标

### 3. 链路追踪

- **请求 ID**: 每个请求分配唯一 ID
- **调用链**: 跟踪请求在各层的流转
- **性能分析**: 分析各层处理时间

## 部署架构

### 1. 容器化部署

```dockerfile
# 多阶段构建
FROM golang:1.19-alpine AS builder
# 构建应用

FROM alpine:latest
# 运行环境
```

### 2. 服务编排

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: go_demo
```

### 3. 负载均衡

- **反向代理**: Nginx 作为反向代理
- **负载均衡**: 支持多实例部署
- **健康检查**: 自动故障转移

## 扩展性设计

### 1. 水平扩展

- **无状态设计**: 应用层无状态，支持水平扩展
- **数据库分离**: 数据库独立部署
- **缓存分离**: Redis 独立部署

### 2. 功能扩展

- **插件机制**: 支持中间件插件
- **模块化**: 功能模块独立
- **接口抽象**: 便于替换实现

### 3. 性能扩展

- **读写分离**: 数据库读写分离
- **分库分表**: 支持数据分片
- **CDN 加速**: 静态资源 CDN

## 最佳实践

### 1. 代码规范

- **Go 官方规范**: 遵循 Go 代码规范
- **错误处理**: 完整的错误处理机制
- **单元测试**: 完善的测试覆盖

### 2. 安全实践

- **最小权限**: 用户权限最小化
- **定期更新**: 依赖库定期更新
- **安全审计**: 定期安全检查

### 3. 运维实践

- **自动化部署**: CI/CD 流水线
- **监控告警**: 完善的监控体系
- **备份恢复**: 数据备份和恢复策略

## 技术选型

| 组件 | 技术选择 | 原因 |
|------|----------|------|
| Web 框架 | Gin | 高性能、轻量级、生态丰富 |
| ORM | GORM | 功能完善、社区活跃、易用性好 |
| 数据库 | MySQL | 成熟稳定、性能优秀、运维友好 |
| 日志 | Zap | 高性能、结构化、配置灵活 |
| 配置 | Viper | 功能强大、支持多格式、热重载 |
| 验证 | Validator | 功能完善、性能优秀、易扩展 |
| JWT | golang-jwt | 官方推荐、功能完整、安全可靠 |

## 总结

Go Demo 项目采用了现代化的架构设计和技术栈，具有以下优势：

1. **清晰的分层架构**: 职责分离，易于维护和扩展
2. **完善的安全机制**: 多层次安全防护
3. **高性能设计**: 优化的数据库和缓存策略
4. **容器化部署**: 支持现代化的部署方式
5. **可观测性**: 完善的日志和监控体系
6. **可扩展性**: 支持水平和垂直扩展

该架构为构建企业级 Web 应用提供了坚实的基础，可以根据具体业务需求进行定制和扩展。
# 🏗️ Go Demo 项目架构说明

## 项目概述

这是一个基于 Go 语言的 Web 应用项目，采用标准的分层架构设计，包含完整的用户管理和认证系统。

## 技术架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
│                    (浏览器/移动应用/API客户端)                     │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/HTTPS
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Nginx 反向代理层                             │
│  • 负载均衡  • SSL终止  • 静态资源  • 请求转发                     │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      应用层 (Go Application)                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Handler 层 (HTTP 处理器)                     │   │
│  │  • 请求解析  • 参数验证  • 响应封装  • 错误处理            │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │              Service 层 (业务逻辑)                        │   │
│  │  • 业务规则  • 数据处理  • 事务管理  • 缓存策略            │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │            Repository 层 (数据访问)                       │   │
│  │  • CRUD操作  • 查询构建  • 数据映射  • 连接池管理          │   │
│  └────────────────────────┬─────────────────────────────────┘   │
└───────────────────────────┼─────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
        ▼                                       ▼
┌──────────────────┐                  ┌──────────────────┐
│   MySQL 数据库    │                  │   Redis 缓存      │
│  • 用户数据       │                  │  • 会话缓存       │
│  • 业务数据       │                  │  • 限流计数       │
│  • 持久化存储     │                  │  • 分布式锁       │
└──────────────────┘                  └──────────────────┘
```

## Docker 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Docker Host                                 │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              go-demo-network (Bridge Network)              │ │
│  │                                                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │ │
│  │  │   Nginx      │  │     App      │  │    MySQL     │   │ │
│  │  │  Container   │  │  Container   │  │  Container   │   │ │
│  │  │              │  │              │  │              │   │ │
│  │  │  Port: 80    │  │  Port: 8080  │  │  Port: 3306  │   │ │
│  │  │       443    │  │              │  │              │   │ │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │ │
│  │         │                 │                 │           │ │
│  │         └────────┬────────┘                 │           │ │
│  │                  │                          │           │ │
│  │         ┌────────▼────────┐                 │           │ │
│  │         │     Redis       │                 │           │ │
│  │         │   Container     │                 │           │ │
│  │         │                 │                 │           │ │
│  │         │   Port: 6379    │                 │           │ │
│  │         └─────────────────┘                 │           │ │
│  │                                             │           │ │
│  └─────────────────────────────────────────────┼───────────┘ │
│                                                │             │
│  ┌─────────────────────────────────────────────▼───────────┐ │
│  │                    Data Volumes                         │ │
│  │  • mysql_data (持久化数据库)                             │ │
│  │  • redis_data (持久化缓存)                               │ │
│  │  • logs (应用日志)                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## 项目目录结构

```
go_demo/
├── cmd/                          # 应用程序入口
│   └── server/
│       └── init.go              # 服务初始化和启动
│
├── internal/                     # 内部应用代码（不可被外部导入）
│   ├── config/                  # 配置管理
│   │   └── config.go           # 配置结构和加载
│   │
│   ├── handler/                 # HTTP 处理器层
│   │   ├── auth_handler.go     # 认证相关接口
│   │   ├── user_handler.go     # 用户管理接口
│   │   └── health_handler.go   # 健康检查接口
│   │
│   ├── service/                 # 业务逻辑层
│   │   ├── auth_service.go     # 认证业务逻辑
│   │   └── user_service.go     # 用户业务逻辑
│   │
│   ├── repository/              # 数据访问层
│   │   └── user_repository.go  # 用户数据访问
│   │
│   ├── models/                  # 数据模型
│   │   ├── user.go             # 用户模型
│   │   └── auth.go             # 认证模型
│   │
│   ├── middleware/              # 中间件
│   │   ├── auth.go             # JWT 认证中间件
│   │   ├── logging.go          # 日志中间件
│   │   ├── trace.go            # 链路追踪中间件
│   │   └── validator.go        # 参数验证中间件
│   │
│   ├── router/                  # 路由配置
│   │   └── router.go           # 路由注册
│   │
│   ├── di/                      # 依赖注入 (Wire)
│   │   ├── wire.go             # Wire 配置
│   │   ├── providers.go        # 依赖提供者
│   │   └── app.go              # 应用容器
│   │
│   └── utils/                   # 工具函数
│       ├── jwt.go              # JWT 工具
│       ├── response.go         # 响应封装
│       └── ip.go               # IP 工具
│
├── pkg/                         # 可重用的库代码（可被外部导入）
│   ├── database/               # 数据库连接
│   ├── cache/                  # Redis 缓存封装
│   ├── logger/                 # 日志工具
│   ├── validator/              # 参数验证
│   └── errors/                 # 错误处理
│
├── configs/                     # 配置文件
│   ├── config.yaml             # 生产环境配置
│   ├── config.dev.yaml         # 开发环境配置
│   └── config.docker.yaml      # Docker 环境配置
│
├── deployments/                 # 部署配置
│   ├── Dockerfile              # Docker 镜像构建
│   ├── docker-compose.yml      # 完整部署配置
│   ├── docker-compose.simple.yml # 简化部署配置
│   ├── wait-for-services.sh    # 服务等待脚本
│   ├── mysql/                  # MySQL 配置
│   │   └── init.sql           # 数据库初始化脚本
│   └── nginx/                  # Nginx 配置
│       ├── nginx.conf         # Nginx 主配置
│       └── conf.d/            # 站点配置
│
├── docs/                        # 项目文档
├── tests/                       # 测试文件
├── scripts/                     # 脚本文件
├── api/                         # API 文档
├── logs/                        # 日志文件（运行时生成）
│
├── main.go                      # 程序入口
├── go.mod                       # Go 模块定义
├── go.sum                       # 依赖校验
├── Makefile                     # 构建脚本
├── quick-start.sh              # 快速启动脚本
├── QUICK_START.md              # 快速启动文档
└── DOCKER_DEPLOYMENT_GUIDE.md  # Docker 部署指南
```

## 请求处理流程

```
1. 客户端请求
   │
   ▼
2. Nginx 接收请求
   │ • SSL 终止
   │ • 请求转发
   ▼
3. Gin 路由匹配
   │
   ▼
4. 中间件处理
   │ • 日志记录
   │ • 认证验证
   │ • 参数验证
   │ • 限流检查
   ▼
5. Handler 层
   │ • 解析请求
   │ • 调用 Service
   ▼
6. Service 层
   │ • 业务逻辑
   │ • 缓存查询
   │ • 调用 Repository
   ▼
7. Repository 层
   │ • 数据库操作
   │ • GORM 查询
   ▼
8. 数据库/缓存
   │ • MySQL 读写
   │ • Redis 缓存
   ▼
9. 响应返回
   │ • 数据封装
   │ • JSON 序列化
   ▼
10. 客户端接收响应
```

## 核心功能模块

### 1. 认证模块 (Authentication)

```
┌─────────────────────────────────────┐
│         认证流程                     │
├─────────────────────────────────────┤
│  注册 → 密码加密 → 存储用户          │
│  登录 → 验证密码 → 生成 JWT Token    │
│  刷新 → 验证 Refresh Token → 新Token │
│  登出 → Token 加入黑名单             │
└─────────────────────────────────────┘
```

**技术实现**：
- JWT (JSON Web Token) 无状态认证
- BCrypt 密码加密
- Redis 存储 Token 黑名单
- Refresh Token 机制

### 2. 用户管理模块 (User Management)

```
┌─────────────────────────────────────┐
│         用户管理功能                 │
├─────────────────────────────────────┤
│  • 用户列表（分页、搜索、排序）       │
│  • 用户详情                          │
│  • 创建用户                          │
│  • 更新用户                          │
│  • 删除用户                          │
│  • 修改密码                          │
│  • 用户统计                          │
└─────────────────────────────────────┘
```

### 3. 缓存策略

```
┌─────────────────────────────────────┐
│         缓存层次                     │
├─────────────────────────────────────┤
│  L1: 应用内存缓存 (可选)             │
│  L2: Redis 分布式缓存                │
│  L3: MySQL 持久化存储                │
└─────────────────────────────────────┘

缓存策略：
• 用户信息：TTL 1小时
• 会话数据：TTL 7天
• 限流计数：TTL 1分钟
```

### 4. 限流机制

```
┌─────────────────────────────────────┐
│         限流策略                     │
├─────────────────────────────────────┤
│  • 全局限流：100 req/min/IP          │
│  • API 限流：可配置                  │
│  • 用户限流：基于用户ID              │
│  • 实现：Redis + 滑动窗口算法        │
└─────────────────────────────────────┘
```

## 数据模型

### 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE,
    name VARCHAR(100),
    mobile VARCHAR(20),
    status TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status)
);
```

## 配置管理

### 配置优先级

```
环境变量 (最高)
    ↓
配置文件 (中等)
    ↓
默认值 (最低)
```

### 环境配置

| 环境 | 配置文件 | 用途 |
|------|---------|------|
| 开发 | config.dev.yaml | 本地开发 |
| Docker | config.docker.yaml | Docker 部署 |
| 生产 | config.yaml | 生产环境 |

## 日志系统

```
┌─────────────────────────────────────┐
│         日志层次                     │
├─────────────────────────────────────┤
│  • 应用日志 (app.log)                │
│    - 业务逻辑日志                    │
│    - 错误日志                        │
│    - 系统日志                        │
│                                     │
│  • 请求日志 (request.log)            │
│    - HTTP 请求记录                   │
│    - 响应时间                        │
│    - 状态码                          │
│                                     │
│  • 日志轮转                          │
│    - 最大 100MB                      │
│    - 保留 10 个备份                  │
│    - 保留 30 天                      │
│    - 自动压缩                        │
└─────────────────────────────────────┘
```

## 健康检查

```
GET /health

响应示例：
{
  "status": "ok",
  "timestamp": "2025-12-26T19:00:00+08:00",
  "services": {
    "database": "healthy",
    "redis": "healthy"
  }
}
```

## API 端点

### 认证接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/auth/register | 用户注册 |
| POST | /api/v1/auth/login | 用户登录 |
| POST | /api/v1/auth/refresh | 刷新令牌 |
| POST | /api/v1/auth/logout | 用户登出 |
| GET | /api/v1/auth/profile | 获取当前用户信息 |

### 用户管理接口

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | /api/v1/users | 获取用户列表 | ✅ |
| POST | /api/v1/users | 创建用户 | ✅ |
| GET | /api/v1/users/:id | 获取用户详情 | ✅ |
| PUT | /api/v1/users/:id | 更新用户 | ✅ |
| DELETE | /api/v1/users/:id | 删除用户 | ✅ |
| PUT | /api/v1/users/profile | 更新个人资料 | ✅ |
| PUT | /api/v1/users/password | 修改密码 | ✅ |
| GET | /api/v1/users/stats | 用户统计 | ✅ |

## 部署方式对比

| 特性 | 完整部署 | 简化部署 | 本地开发 |
|------|---------|---------|---------|
| 应用 | ✅ Docker | ✅ Docker | ✅ 本地运行 |
| MySQL | ✅ Docker | ✅ Docker | ✅ Docker |
| Redis | ✅ Docker | ✅ Docker | ✅ Docker |
| Nginx | ✅ Docker | ❌ | ❌ |
| 适用场景 | 生产环境 | 测试环境 | 开发调试 |
| 启动命令 | `docker-compose up -d` | `docker-compose -f docker-compose.simple.yml up -d` | `./quick-start.sh` 选项3 |

## 性能指标

### 资源使用（参考值）

| 服务 | CPU | 内存 | 磁盘 |
|------|-----|------|------|
| App | 0.5-2 核 | 512MB-1GB | 100MB |
| MySQL | 1-2 核 | 1-2GB | 5-10GB |
| Redis | 0.5-1 核 | 256-512MB | 1GB |
| Nginx | 0.5 核 | 128MB | 50MB |

### 性能基准

- **并发处理**: 1000+ req/s
- **响应时间**: < 100ms (P95)
- **数据库连接池**: 50-200 连接
- **Redis 连接池**: 10 连接

## 安全特性

```
┌─────────────────────────────────────┐
│         安全措施                     │
├─────────────────────────────────────┤
│  ✅ JWT 认证                         │
│  ✅ BCrypt 密码加密                  │
│  ✅ HTTPS/SSL 支持                   │
│  ✅ 请求限流                         │
│  ✅ SQL 注入防护 (GORM)              │
│  ✅ XSS 防护                         │
│  ✅ CORS 配置                        │
│  ✅ 参数验证                         │
│  ✅ 日志脱敏                         │
│  ✅ 非 root 用户运行                 │
└─────────────────────────────────────┘
```

## 监控和运维

### 日志查看

```bash
# 应用日志
docker-compose logs -f app

# 数据库日志
docker-compose logs -f mysql

# 所有服务日志
docker-compose logs -f
```

### 资源监控

```bash
# 查看资源使用
docker stats

# 查看容器状态
docker-compose ps
```

### 数据备份

```bash
# 备份数据库
docker-compose exec mysql mysqldump -uroot -p123456 go_demo > backup.sql

# 备份 Redis
docker-compose exec redis redis-cli SAVE
docker cp go-demo-redis:/data/dump.rdb ./backup.rdb
```

## 扩展性

### 水平扩展

```
┌─────────────────────────────────────┐
│         负载均衡                     │
│         (Nginx)                     │
└────────┬────────┬────────┬──────────┘
         │        │        │
    ┌────▼───┐ ┌─▼────┐ ┌─▼────┐
    │ App 1  │ │ App 2│ │ App 3│
    └────┬───┘ └──┬───┘ └──┬───┘
         │        │        │
         └────────┼────────┘
                  │
         ┌────────▼────────┐
         │  MySQL/Redis    │
         │   (共享存储)     │
         └─────────────────┘
```

### 微服务拆分

可以将项目拆分为：
- 用户服务
- 认证服务
- 通知服务
- 等...

## 总结

这个项目采用了现代化的 Go Web 开发最佳实践：

✅ **清晰的分层架构** - 易于维护和扩展  
✅ **完整的 Docker 化** - 一键部署  
✅ **标准的 RESTful API** - 易于集成  
✅ **完善的文档** - 快速上手  
✅ **生产级特性** - 可直接用于生产环境  

---

**相关文档**：
- [快速启动指南](QUICK_START.md)
- [Docker 部署指南](DOCKER_DEPLOYMENT_GUIDE.md)
- [项目 README](README.md)
